name: Run Rector(Laravel and PHP)

on:
  # Triggers the workflow on pull request events
  pull_request:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run_ecs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
        - name: Checkout code
          uses: actions/checkout@v3
          with:
            ref: ${{ github.event.pull_request.head.sha }}

        - name: Setup PHP
          uses: shivammathur/setup-php@2.18.0
          with:
           php-version: 8.2

        - name: Install dependencies
          run: |
            composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
            composer update --prefer-stable --prefer-dist --no-interaction

        - name: Rector
          run: ./vendor/bin/rector process --clear-cache --no-progress-bar

        - name: Fetch latest changes from main
          run: git fetch origin main

        - name: Fetch latest changes from current branch
          run: git fetch origin ${{ github.event.pull_request.head.ref }}

        - name: Prepare git user
          run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "action@github.com"

        - name: Commit and push changes
          run: |
            git add .
            git commit -m "code: refactor by rector"
            git push
