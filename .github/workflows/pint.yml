name: Run Laravel Pint

on:
  # Triggers the workflow on pull request events
  pull_request:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run_pint:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
        - name: Checkout code
          uses: actions/checkout@v3
          with:
            ref: ${{ github.event.pull_request.head.sha }}

        - name: Setup PHP
          uses: shivammathur/setup-php@2.18.0
          with:
           php-version: 8.2

        - name: Install dependencies
          run: |
            composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
            composer update --prefer-stable --prefer-dist --no-interaction

        - name: Pint
          run: ./vendor/bin/pint

        - name: Fetch latest changes from main
          run: git fetch origin main

        - name: Fetch latest changes from current branch
          run: git fetch origin ${{ github.event.pull_request.head.ref }}

        - name: Prepare git user
          run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "action@github.com"

        - name: Commit and push changes
          run: |
            if [[ -z $(git status --porcelain) ]]; then
                echo "Nothing to fix.. Exiting."
                exit 0
            fi
                git commit -am "code: refactor by pint"
                git push origin $GITHUB_REF_NAME --force
            fi
            exit 1
